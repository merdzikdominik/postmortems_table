<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postmortem - Gaps Identification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='slimselect.css') }}">
</head>
<body>
    <button style="background-color: #ff6200;" class="w-100 btn text-light rounded-0" id="create-row-btn">Add Postmortem Info</button>
    <button class=" w-100 btn btn-primary text-light rounded-0" id="edit-postmortem">Edit postmortem</button>
    <!--  edit table modal  -->
    <div class="modal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-center z-2" role="document">
            <div style="width: 1150px;" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit postmortem</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table" id="rows-table-edit">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Incident</th>
                                <th scope="col">Prep</th>
                                <th scope="col">Assigned To</th>
                                <th scope="col">Issue Date</th>
                                <th scope="col">In Scope</th>
                                <th scope="col">Comments</th>
                                <th scope="col">Identified Issue</th>
                                <th scope="col">RCA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows %}
                                <tr id="{{ row.id }}">
                                    <th scope="row">{{ row.id }}</th>
                                    <td>{{ row.incident }}</td>
                                    <td>{{ row.prep }}</td>
                                    <td>{{ row.assigned_to }}</td>
                                    <td>{{ row.issue_date }}</td>
                                    <td>{{ row.in_scope }}</td>
                                    <td>{{ row.comments }}</td>
                                    <td>{{ row.identified_issue }}</td>
                                    <td>{{ row.rca }}</td>
                                    <td>
                                        <button class="btn btn-primary edit-row-btn">Edit</button>
                                        <button class="btn btn-danger delete-row-btn">Delete</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-changes">Save changes</button>
                </div>
            </div>
        </div>
        <div style="height: 100%;" class="w-100 bg-secondary fixed-top z-1 opacity-25" id="modal-backdrop"></div>
    </div>

    <!--  main section  -->
    <div class="w-50 container d-flex-column justify-content-center">
        <h1 class="mt-3 mb-3">Postmortem Info</h1>
        <form id="row-form" method="POST" action="/">
            {{ form.hidden_tag() }}
            <div class="mt-4 mb-4">
                <label for="incident">Incident:</label>
                <input type="text" class="form-control" required id="incident" name="incident" placeholder="Provide incident reference">
            </div>

            <div class="mt-4 mb-4">
                <div class="col-sm-6">
                    <div class="input-group input-group-sm gap-2">
                        <label class="form-check-label" for="prep_checkbox">Prep</label>
                        <input type="checkbox" style="accent-color: #ff6200;" class="form-check" id="prep_checkbox" name="prep_checkbox">
                    </div>
                </div>
                <label for="prep_date" id="prep_date_label">Prep date:</label>
                <input type="date" style="accent-color: #ff6200;" class="form-control" id="prep_date" name="prep_date">
            </div>

            <div class="mt-4 mb-4">
                <label for="assigned_to">Assigned To:</label>
                <input type="text" class="form-control" required id="assigned_to" name="assigned_to" placeholder="eg. JoDo (John Doe)">
            </div>

            <div class="mt-4 mb-4">
                <label for="issue_date">Issue Date:</label>
                <input type="date" style="accent-color: #ff6200;" class="form-control" required id="issue_date" name="issue_date">
            </div>

            <div class="col-sm-6">
                <div class="input-group input-group-sm gap-2">
                    <label class="form-check-label" for="in_scope">In scope</label>
                    <input type="checkbox" style="accent-color: #ff6200;" class="form-check" id="in_scope" name="in_scope">
                </div>
            </div>

            <div class="mt-4 mb-4">
                <label for="comments">Comments:</label>
                <textarea id="comments" class="form-control" name="comments" placeholder="Provide additional information if necessary"></textarea>
            </div>

            <div class="mt-4 mb-4">
                <label for="identified_issue">Choose identified issue or add new one</label>
                <select class="form-control" id="identified_issue" name="identified_issue" multiple>

                </select>
            </div>

            <div class="mt-4 mb-4 d-flex flex-column gap-2">
                <label>Root Cause Analysis</label>
                <div class="btn-group">
                    <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pick Root Cause</button>
                    <div style="margin-top: 37px;" class="dropdown-menu w-100">
                        <span class="dropdown-item">Caused by Change</span>
                        <span class="dropdown-item">Data error</span>
                        <span class="dropdown-item">Provider error</span>
                        <span class="dropdown-item">Business User error</span>
                        <span class="dropdown-item">Security - Access</span>
                        <span class="dropdown-item">Security - Other</span>
                        <span class="dropdown-item">Security - Lost/stolen</span>
                        <span class="dropdown-item">Power failure</span>
                        <span class="dropdown-item">Capacity issue</span>
                        <span class="dropdown-item">Design issue</span>
                        <span class="dropdown-item">External cause</span>
                        <span class="dropdown-item">Application error</span>
                        <span class="dropdown-item">Infrastructure error</span>
                        <div class="dropdown-divider"></div>
                        <span class="dropdown-item">Unknown</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="rca" name="rca">

            <button style="background-color: #ff6200;" type="submit" id="submit" class="w-100 btn text-light mb-4">Add info</button>
        </form>
    </div>

    <div class="w-100 container d-flex flex-column mx-auto justify-content-center">
        <div class="container text-center">
            <div class="row">
                <div class="col text-start equal-width">
                    <h2 class="mt-4 mb-4">Postmortem table</h2>
                </div>
                <div class="col equal-width">
                    <div class="input-group mb-3 mt-4 input-group-custom">
                        <span class="input-group-text" id="basic-addon1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                                <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z"/>
                            </svg>
                        </span>
                        <input type="text" id="userFilter" class="form-control" placeholder="Filter for user" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                </div>
            </div>
        </div>
        <table class="table" id="rows-table">
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Incident</th>
                    <th scope="col">Prep</th>
                    <th scope="col">Assigned To</th>
                    <th scope="col">Issue Date</th>
                    <th scope="col">In Scope</th>
                    <th scope="col">Comments</th>
                    <th scope="col">Identified Issue</th>
                    <th scope="col">RCA</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                        <th scope="row">{{ row.id }}</th>
                        <td>{{ row.incident }}</td>
                        <td>{{ row.prep }}</td>
                        <td>{{ row.assigned_to }}</td>
                        <td>{{ row.issue_date }}</td>
                        <td>{{ row.in_scope }}</td>
                        <td>{{ row.comments }}</td>
                        <td>{{ row.identified_issue }}</td>
                        <td>{{ row.rca }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script src="{{url_for('static', filename='slimselect.min.js')}}"></script>
    <script>
        const prepCheckbox = document.getElementById("prep_checkbox");
        const prepDate = document.getElementById("prep_date");
        const prepDateLabel = document.getElementById("prep_date_label");

        prepDate.style.display = "none";
        prepDateLabel.style.display = "none";

        document.getElementById("row-form").style.display = "none";
        document.getElementsByTagName("h1")[0].style.display = "none";

        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        prepCheckbox.addEventListener("change", function() {
            if (this.checked) {
                prepDate.style.display = "block";
                prepDateLabel.style.display = "block";
            } else {
                prepDate.style.display = "none";
                prepDateLabel.style.display = "none";
            }
        });

        document.getElementById("create-row-btn").addEventListener("click", function() {
            const display = document.getElementById("row-form").style.display;

            switch(display) {
                case 'none':
                    document.getElementById("row-form").style.display = "block";
                    document.getElementsByTagName("h1")[0].style.display = "block";

                    fetch('/get_issues')
                    .then(response => response.json())
                    .then(data => {
                        const slimSelect = new SlimSelect({
                            select: '#identified_issue',
                            data: data.map(issue => ({ text: issue.text })),
                            events: {
                                addable: function (value) {
                                    return new Promise((resolve, reject) => {
                                        fetch('http://localhost:5000/add_option', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ value: value })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.message === 'Issue added successfully') {
                                                resolve({ text: value });
                                            } else {
                                                reject(data.message);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            reject(error);
                                        });
                                    });
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error:', error));


                    break;

                case 'block':
                    document.getElementById("row-form").style.display = "none";
                    document.getElementsByTagName("h1")[0].style.display = "none";

                    break;

                default:
                    document.getElementById("row-form").style.display = "none";
                    document.getElementsByTagName("h1")[0].style.display = "none";

                    break;
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const dropdownButton = document.querySelector(".dropdown-toggle");
            const dropdownMenu = document.querySelector(".dropdown-menu");
            const dropdownItems = document.querySelectorAll(".dropdown-item");

            dropdownMenu.style.display = "none";

            dropdownButton.addEventListener("click", () => {
                if (dropdownMenu.style.display === "block") {
                    dropdownMenu.style.display = "none";
                } else {
                    dropdownMenu.style.display = "block";
                }
            });

            dropdownItems.forEach(item => {
                item.addEventListener("click", () => {
                    const selectedValue = item.textContent.trim();
                    document.getElementById("rca").value = selectedValue;
                    dropdownMenu.style.display = "none";
                });
            });

            document.addEventListener("click", (event) => {
                if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.style.display = "none";
                }
            });

            const form = document.getElementById("row-form");

            form.addEventListener("submit", (event) => {
                event.preventDefault();

                const identifiedIssueSelect = document.getElementById("identified_issue");
                const selectedOptions = Array.from(identifiedIssueSelect.selectedOptions).map(option => option.value);
                const selectedIssues = selectedOptions.join(', ');

                document.getElementById("identified_issue").value = selectedIssues;

                const formData = new FormData(form);
                formData.append('identified_issue', selectedIssues);

            });

            const editPostmortem = document.getElementById("edit-postmortem");
            const modal = document.getElementById('exampleModal');
            const modalBackdrop = document.getElementById('modal-backdrop');

            modalBackdrop.style.display = "none";
            modal.style.display = "none";

            editPostmortem.addEventListener("click", () => {
                if (modal.style.display === "none") {
                    modal.style.display = "block";
                    modalBackdrop.style.display = "block";

                } else {
                    modal.style.display = "none";
                }
            });

            modalBackdrop.addEventListener("click", () => {
                modal.style.display = "none";
                modalBackdrop.style.display = "none";

                location.reload()
            });

            document.querySelectorAll(".delete-row-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const row = this.closest("tr");
                    const rowId = row.getAttribute("id");

                    fetch(`/delete_row/${rowId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": "{{ csrf_token() }}"
                        },
                    }).then(response => {
                        if (response.ok) {
                            row.remove();
                        } else {
                            console.error('Failed to delete the row.');
                        }
                    }).catch(error => console.error('Error:', error));
                });
            });

            const editedRows = new Set();
            let finalSelectedOptions = '';

            document.querySelectorAll('.edit-row-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const cells = row.querySelectorAll('td');

                    const incident = cells[0].textContent.trim();
                    const prep = cells[1].textContent.trim();
                    const assignedTo = cells[2].textContent.trim();
                    const issue_date = cells[3].textContent.trim();
                    const inScope = cells[4].textContent.trim();
                    const comments = cells[5].textContent.trim();
                    const identified_issue = cells[6].textContent.trim();
                    const rca = cells[7].textContent.trim();

                    const availableAssignedToOptions = [
                        'RaAd',
                        'JaBe',
                        'PiCz',
                        'ZuDą',
                        'AdGo',
                        'ArIr',
                        'GrKo',
                        'KrLa',
                        'MiŁu',
                        'DoMe',
                        'MaSi',
                        'ToWi',
                        'RaZa',
                        'MaZi'
                    ];

                    const dropdownOptions = availableAssignedToOptions.map(option => {
                        return `<option value="${option}" ${assignedTo.includes(option) ? 'selected' : ''}>${option}</option>`;
                    });

                    cells[0].innerHTML = `<input type="text" class="form-control" name="incident_${row.id}" value="${incident}" placeholder="${incident}">`;
                    cells[1].innerHTML = `<input type="text" class="form-control" name="prep_${row.id}" value="${prep}" placeholder="${prep}">`;
                    cells[2].innerHTML = `<select id="selectElement-${row.id}" class="form-control" name="assigned_to_${row.id}" multiple>${dropdownOptions}</select>`;
                    cells[3].innerHTML = `<input type="date" class="form-control" name="issue_date_${row.id}" value="${issue_date}" placeholder="${issue_date}">`;
                    cells[4].innerHTML = `<input type="checkbox" class="form-check-input" name="in_scope_${row.id}" ${inScope === 'Yes' ? 'checked' : ''}>`;
                    cells[5].innerHTML = `<textarea class="form-control" name="comments_${row.id}" placeholder="${comments}">${comments}</textarea>`;
                    cells[6].innerHTML = `<input type="text" class="form-control" name="identified_issue_${row.id}" value="${identified_issue}" placeholder="${identified_issue}">`
                    cells[7].innerHTML = `<input type="text" class="form-control" name="rca_${row.id}" value="${rca}" placeholder="${rca}">`;

                    new SlimSelect({
                        select: `#selectElement-${row.id}`
                    });

                    const selectElement = cells[2].querySelector('select');

                    selectElement.addEventListener('change', function() {
                        const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);
                        finalSelectedOptions = selectedOptions.join(', ');
                        console.log('Selected options:', finalSelectedOptions);
                    });

                    this.style.display = 'none';

                    editedRows.add(row.id);

                });
            });

            const saveButton = document.getElementById('save-changes');

            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    const editedRowsData = [];
                    const csrfToken = '{{ csrf_token() }}';

                    document.querySelectorAll('tr[id]').forEach(row => {
                        if (editedRows.has(row.id)) {
                            const rowData = { id: row.id };
                            row.querySelectorAll('input, textarea, select').forEach(input => {
                                const name = input.name;
                                if (input.tagName.toLowerCase() === 'select' && input.multiple) {
                                    rowData[name] = Array.from(input.selectedOptions).map(option => option.value).join(', ');
                                } else if (input.type === 'checkbox') {
                                    rowData[name] = input.checked ? 'Yes' : 'No';
                                    if (!input.checked) {
                                        rowData[name] = 'No';
                                    }
                                } else {
                                    rowData[name] = input.value;
                                }
                            });

                            editedRowsData.push(rowData);
                        }
                    });

                    const formData = new URLSearchParams();
                    formData.append('csrf_token', csrfToken);

                    editedRowsData.forEach((rowData) => {
                        for (const key in rowData) {
                            formData.append(`${key}`, rowData[key]);
                        }
                    });

                    console.log('Form Data:', formData.toString());

                    fetch(`/save_changes`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrfToken
                        },
                        body: formData.toString()
                    }).then(response => {
                        if (response.ok) {
                            console.log('Changes saved successfully.');

                            editedRows.forEach(rowId => {
                                const row = document.getElementById(rowId);
                                const cells = row.querySelectorAll('td');

                                cells[0].textContent = row.querySelector(`[name="incident_${rowId}"]`).value;
                                cells[1].textContent = row.querySelector(`[name="prep_${rowId}"]`).value;
                                const assignedToSelect = document.createElement('select');
                                const selectedOptions = Array.from(row.querySelectorAll(`[name="assigned_to_${rowId}"] option[selected]`));
                                selectedOptions.forEach(option => {
                                    assignedToSelect.appendChild(option.cloneNode(true));
                                });
                                cells[3].textContent = row.querySelector(`[name="issue_date_${rowId}"]`).value;
                                cells[4].textContent = row.querySelector(`[name="in_scope_${rowId}"]`).checked ? 'Yes' : 'No';
                                cells[5].textContent = row.querySelector(`[name="comments_${rowId}"]`).value;
                                cells[6].textContent = row.querySelector(`[name="identified_issue_${rowId}"]`).value;
                                cells[7].textContent = row.querySelector(`[name="rca_${rowId}"]`).value;
                            });

                            editedRows.clear();

                            const editButtons = document.querySelectorAll('.edit-row-btn');

                            editButtons.forEach(button => {
                                button.style.display = 'block';
                            });

                        } else {
                            console.error('Failed to save changes.');
                        }
                    }).catch(error => console.error('Error:', error));
                });
            }

            const filterInput = document.getElementById("userFilter");

            filterInput.addEventListener("keyup", function() {
                const filterValue = filterInput.value.toLowerCase();
                const tableRows = document.querySelectorAll("#rows-table tbody tr");

                tableRows.forEach(row => {
                    const assignedToCell = row.querySelector("td:nth-child(4)");
                    if (assignedToCell) {
                        const cellText = assignedToCell.textContent.toLowerCase();
                        if (cellText.includes(filterValue)) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    }
                });
            });
        });

    </script>
</body>
</html>